#XML-протокол обмена платёжной системы "Payin-Payout" для внешних агентов 

##1 Введение

Настоящий XML-протокол предназначен для проведения платежей внешними агентами через систему payin-payout. Обмен данными 
между клиентами и сервером приложений в системе происходит по протоколу HTTP или HTTPS методом POST. Клиент осуществляет 
запрос определенного вида в кодировке UTF-8 на сервер, где запрос обрабатывается, и возвращается ответ также в 
определенном формате. Для работы по XML-протоколу необходимо передать нашему менеджеру публичный ключ.
 
URL для обращения клиента по протоколу:

https://lk.payin-payout.net/api_out/

В клиент должен принимать самоподписанные сертификаты.
 
##2 Формат передачи данных

|Протокол:|Метод передачи|
|---|---|
|Передача данных между клиентским и серверным ПО построена на протоколе HTTP (RFC 2616: HTTP/1.1).|Для передачи данных используется метод RAW POST  – поток данных передается в теле запроса, отправляемого клиентом на сервер. Данные передаются в формате XML (Extensible Markup Language (XML) 1.0).|

 
##3 Авторизация

При обработке запроса от клиентского ПО выполняется авторизация клиента.
 
XML пакет подписывается цифровой подписью (ЭЦП), при этом в заголовок (header)  HTTP помещается следующая информация:
 
* "Amega-Sign" – текст ЭЦП, завернутый в BASE64;
 
* "Amega-Hash-Alg"  – алгоритм вычисления ЭЦП (MD5, SHA1, SHA256);
 
* "Amega-UserId" – идентификатор пользователя.

* "Amega-ProtocolVersion" - версия протокола (по умолчанию 1)

##4 Описание API

###4.1 Модуль «Агенты»

Описание: Все операции по агентам в системе payin-payout
 
Интерфейс: **Agents**

###4.1.1 Запрос баланса

Описание: Запрос баланса агента в системе payin-payout

Команда: **getBalance**

###4.1.1.1 Запрос
```
<?xml version="1.0" encoding="UTF-8"?> 
<request> 
	<action id="Agents.getBalance" />
</request> 
```

* **request**  — корневой тег запроса

* **action**  — тег содержащий действие

  * **id**  — идентификатор действия
 
* **agentId**  — уникальный идентификатор агента в системе #payin-payout

###4.1.1.2 Ответ
```
<?xml version="1.0" encoding="UTF-8"?>
<response id="Agents.getBalance" result="0">
	<action>
		<balance>10314.77</balance>
	</action>
</response>
```

* **response**  — корневой тег ответа

  * **result**  — результат авторизации агента, если равен 0, то авторизация прошла успешно, иначе выводится код ошибки

  * **action**  — тег содержащий действие

    * **result**  — результат выполнения действия, если равен 0, то выполнение прошло успешно, иначе выводится код ошибки

  * **balance**  — баланс агента в рублях (разделитель точка 

### 4.1.1.3 Запрос баланса для всех валют

```
<?xml version="1.0" encoding="UTF-8"?>
<request>
    <action id="Agents.getBalance">
        <currency>ALL</currency>
    </action>
</request>
```

### 4.1.1.4 Ответ с информацией о балансе

```
<?xml version="1.0" encoding="UTF-8"?>
<response id="Agents.getBalance" result="0">
    <action>
        <balance currency="643">100.00</balance>
        <balance currency="840">100.00</balance>
        <balance currency="978">100.00</balance>
    </action>
</response>
```

### 4.1.1.5 Запрос баланса конкретной валюты

При запросе баланса валюта указывается в цифровом коде согласно ISO 4217.

```
<?xml version="1.0" encoding="UTF-8"?>
<request>
    <action id="Agents.getBalance">
        <currency>978</currency>
    </action>
</request>
```

### 4.1.1.6 Ответ с информацией о балансе

```
<?xml version="1.0" encoding="UTF-8"?>
<response id="Agents.getBalance" result="0">
    <action>
        <balance currency="978">100.00</balance>
    </action>
</response>
```

##4.2 Модуль «Платежи»


Описание: Все операции по платежной системе payin-payout 

Интерфейс: **Payments**

###4.2.1 Верификация платежа

Описание: Запрос на проверку введенных
 
Команда: **verifyPayment**

###4.2.1.1 Запрос
```
<?xml version="1.0" encoding="UTF-8"?>
<request>
	<action id="Payments.verifyPayment" >
		<payment id="10">
			<serviceId>1008</serviceId>
			<fields>
				<phone>9237500001</phone>
			</fields>
			<amount>20</amount>
		</payment>
	</action>
</request>
```

* **id**  — идентификатор транзакции в системе агента

* **serviceId** — идентификатор сервиса в системе payin-payout

* **fields** — набор полей для провеки платежа

  * **phone**  —  номер счета/телефона абонента.
 
* **amount**  — сумма на счет клиента

Существует персональная настройка для онлайн проверки платежа на стороне провайдера. Для ее включения нужно обратиться 
к менеджеру системы. Эта опция нужна клиентам чей бизнес завязан на онлайн проведение.
 
###4.2.1.2 Ответ
 ```
<?xml version="1.0" encoding="UTF-8"?>
<response result="0">
	<action id="Payments.verifyPayment" result="0">
		<payment id="10" result="1" state="1"/>
	</action>
</response>
```
где

* **result** — статус проверки на стороне провайдера 0 — успешно, 1 — проверяется, 2 — ошибка.

* **state** — статус ответа 0 — финален, 1 — не финален.

* **message** — сообщение в случае ошибки.

*Примечание: в случае ошибки id платежа не возвращается.*

###4.2.1.3 Ответ
```
<?xml version="1.0" encoding="UTF-8"?>
<response result="0">
	<action id="Payments.verifyPayment" result="0">
		<payment id="10" result="0" />
	</action>
</response>
```

* **result**  — результат проверки абонента, если равен 0, то проверка прошла успешно

* **id**  — идентификатор транзакции в системе агента
 
###4.2.1.4 Ответ для платежа с невернозаполненным полем
```
<?xml version="1.0" encoding="UTF-8"?>
<response result="0">
    <action id="Payments.verifyPayment" result="0">
        <payment result="2" status="2" field="Account" message="validators.incorrect_email 124235"/>
    </action>
</response>
```

* **result** — статус проверки на стороне провайдера 0 — успешно, 1 — проверяется, 2 — ошибка.

* **state** — статус ответа 0 — финален, 1 — не финален.

* **field** — Название поле.

* **message** — текст ошибки.

###4.2.1 Проведение платежа

Описание: Запрос на проведение платежа 

Команда: **createPayment**

###4.2.1.1 Запрос
```
<?xml version="1.0" encoding="UTF-8"?>
<request>
	<action id="Payments.createPayment" >
		<payment id="10" >
		<serviceId>1008</serviceId>
			<fields><phone>9237500001</phone></fields>
		<amount>20</amount>
		<dateTime>2014-09-24 14:06:06</dateTime>
		<comment>pay</comment>
	</payment>
</action>
</request>
```

* **id**  — уникальный идентификатор платежа в системе агента

* **serviceId**  — идентификатор сервиса в системе payin-payout

* **phone** — набор полей для провеки платежа

  * **phone**  —  номер счета/телефона абонента. 

* **amount**  — сумма на счет клиента

* **dateTime**  — дата принятия платежа в формате  "YYYY-MM-dd HH:mm:ss"

* **comment** — комментарий к платежу

###4.2.1.2 Ответ
```
<?xml version="1.0" encoding="UTF-8"?>
<response result="0">
	<action id="Payments.createPayment" result="0">
		<payment id="10" result="0" status="0" uid="006064-000091"/>
	</action>
</response>
```

* **id**  — уникальный идентификатор платежа в системе агента

* **status**  — статус платежа, если 1 проведен успешно, 2 не проведен статус конечен, 0 в обработке

* **result**  — код ошибки, если 0 ошибок нет

* **uid**  — уникальный идентификатор платежа в системе payin-payout

###4.2.2 Проверка статуса платежа

Описание: Запрос на проверку статуса платежа 

Команда: **getPaymentStatus** 

###4.2.2.1 Запрос
```
<?xml version="1.0" encoding="UTF-8"?>
<request>
	<action id="Payments.getPaymentStatus" >
		<payment uid="006064-000091" />
	</action>
</request>
```

###4.2.2.2 Ответ
```
<?xml version="1.0" encoding="UTF-8"?>
<response id="Agents.getPaymentStatus" result="0">
	<action>
		<payment uid="006064-000091" result="0" status="0" message="Платеж находится в обработке"/>
	</action>
</response>
```

###4.2.3 Список провайдеров

Описание: Запрос на получение списка провайдеров. Данная команда позволяет получить список доступных для оплаты провайдеров. 

Команда: **getProviders**

###4.2.3.1 Запрос
```
<?xml version="1.0" encoding="UTF-8"?>
<request>
	<action id="Payments.getProviders" />
</request>
```

###4.2.3.2 Ответ
```
<?xml version="1.0" encoding="UTF-8"?>
<response result="0">
	<action id="Payments.getProviders" result="0">
		<provider fullName="Мегафон" groupId="25" id="1008" shortName="Мегафон"
                  icon="/images/services/service_icon_34_normal.jpg"
                  icon_hires="/images/services/service_icon_hd_34_big.jpg">
            <fields>
                <field name="phone" title="Номер телефона" type="tel">
                    <validator regexp="^[\d]{10}$"/>
                </field>
            </fields>
            <commissions>
                <commission currency="643" minAmount="1" maxAmount="15000">
                    <range from="1" type="0" value="3.85"/>
                </commission>
            </commissions>
            <tag_list/>
        </provider>
		<provider fullName="VISA/MASTERCARD мир мультивалютная" groupId="1" id="7005"
                  shortName="VISA/MASTERCARD мир мультивалютная">
            <fields>
                <field name="card_number" title="Номер карты" type="text">
                    <validator regexp="^\d{16,24}$"/>
                </field>
                <field name="expiry_month" title="Срок действия месяц" type="text">
                    <validator regexp="(0[1-9]|1[012])"/>
                </field>
                <field name="expiry_year" title="Срок действия год" type="text">
                    <validator regexp="^\d{2}$"/>
                </field>
                <field name="card_Holder" title="Держатель карты" type="text">
                    <validator regexp="^.{3,255}$"/>
                </field>
                <field name="card_Holder_Country" title="Страна держателя карты" type="select">
                    <item key="ru">Россия</item>
                    <item key="by">Белоруссия</item>
                    <item key="ua">Украина</item>
                </field>
                <field name="card_Holder_Address" title="Адрес держателя карты" type="text">
                    <validator regexp="^.{5,255}$"/>
                </field>
            </fields>
            <commissions>
                <commission currency="978" minAmount="5" maxAmount="5000">
                    <range from="5" type="1" value="6.99"/>
                    <range from="5" type="0" value="7.5"/>
                </commission>
            </commissions>
            <tag_list/>
        </provider>
        </action>
</response>
```

где 

*field — описание типов*

**type** =  text — тип поле текст

**type** =  select — тип поля выпадающий список 

**validator** — валидатор для поля

*range — описание типов*

**type** = 1  — комиссия в процентах

**type** = 0 — комиссия в рублях

###4.3.1 Получение предварительной информации

Описание: Запрос на получение предварительной информации, требуемой для создания платежа. (Наглядным примером является 
продажа «купонов», например пользователь не может пополнить счёт на произвольную сумму, а может только купить «купон» 
эквивалентный некоторой сумме, на которую будет пополнен счёт)
 
Команда: **getPrecheckStatus**

```
4.3.1.1 Запрос
<?xml version="1.0" encoding="UTF-8"?> 
<request> 
	<action id="Payments.getPrecheckStatus" > 
		<tocheck phone="+79234567890" service="9999" /> 
	</action> 
</request>
```

* **id**  — команда

* **service**  — идентификатор сервиса в системе payin-payout

* **phone**  —  номер счета/телефона абонента.

В случае использования данной библиотеки запрос можно совершить выполнив следующий код:

```
$gate = new PayOut();
$gate->setPoint('8888'); //идентификатор пользователя

$payment = [
    'service_id'	=> 9999, //идентификатор сервиса
    'phone'=> '+79234567890', //номер телефона
];

$xml_answer = $gate->getPreCheckStatus($payment); //получение xml с результатами запроса
```
 
###4.3.1.2 Ответ

Формат ответа может зависеть от различных факторов и полученный набор параметров также может отличаться в зависимости 
от типа пополняемого счёта (мобильный телефон, пластиковая карта, штраф ГИБДД) но он всегда обеспечивает необходимое для 
совершения платежа количество информации.

Ниже приведён формат ответа для сервиса «Пополнение мобильного универсальное».

* **country**  — страна в которой находится мобильный оператор абонента

* **operator**  — наименование оператора

* **coupon_list**  —  контейнер для элементов описывающих возможные суммы пополнения

* **coupon** — сам элемент, содержащий информацию о параметрах пополнения в атрибутах, содержимое тега это сумма в валюте 
мобильного оператора которая будет зачислена на счёт телефона

* **cost** — сумма которая будет списана со счёта при совершении платежа

* **charge** — сумма на которую будет пополнен мобильный телефон, эквивалент содержимого тега, но выводится в USD.

* **result**  — код ошибки, если 0 ошибок нет

```
<?xml version="1.0" encoding="UTF-8"?> 
<response id="Agents.getPrecheckStatus" result="0"> 
    <action> 
        <country>Russia</country> 
        <operator>Megafon-Siberia Russia</operator> 
        <coupon_list> 
            <coupon cost="1.22USD" charge="1.10USD">50RUB</coupon> 
            <coupon cost="2.41USD" charge="2.17USD">100RUB</coupon> 
	....................................................
        </coupon_list> 
    </action> 
</response>
```

##Обработка ошибок в нестандартных ситуациях

В некоторых случаях могут складываться нестандартные ситуации, в таких случаях API будет возвращать сообщение такого
вида:

```
<response result="0">
    <action id="Payments.verifyPayment" result="0">
        <payment result="1" status="2"/>
    </action>
</response>
```

При получении сообщения такого вида (которое отличается от описанного выше ответа на проверку введённых данных, вместо
параметра state используется параметр status) следует проверить корректность отправляемых вами данных, и если проверка
 показывает, что с вашей стороны всё происходит корректно, следует обратиться в техподдержку.

##Приложение  А: Справочник статусов платежей

|Статус|Описание                               |Конечен|
|------|---------------------------------------|-------|
|1     |Платеж успешно принят оператором       |Да     |
|2     |Фатальная ошибка при проведении платежа|Да     |
|0     |Платеж находится в стадии обработки    |Нет    |


##Приложение  B: Справочник кодов завершения

|Код завершения|Описание                                                      |
|--------------|--------------------------------------------------------------|
|116           |Платеж не найден                                              |
|117           |Суммы недостаточно для проведения платежа                     |
|115           |Платеж уже существует                                         |
|118           |Не корректный email адрес                                     |
|0             |OK                                                            |
|100           |Неверный формат запроса                                       |
|101           |Неверная подпись агента                                       |
|102           |Идентификатор пользователя не найден                          |
|103           |Идентификатор агента не найден                                |
|104           |Тип архива не поддерживается                                  |
|105           |Ошибка при запаковки архива                                   |
|106           |Ошибка при распаковки архива                                  |
|107           |Не прошел проверку подписи                                    |
|108           |Ошибка при формировании подписи                               |
|109           |Ошибка при верификации подписи                                |
|110           |Ошибка при выполнении программы                               |
|111           |Данный тип запроса(команды) не найден                         |
|112           |Ошибка при формировании ответа                                |
|113           |Ошибка при разборе ответа                                     |
|114           |Тип парсера не найден                                         |
|2             |Неверно указан номер телефона/счета                           |
|3             |Операция отклонена за давностью                               |
|4             |Сервис не найден или заблокирован                             |
|5             |Недостаточно средств для проведения платежа                   |
|6             |Ставка вознаграждений больше допустимой                       |
|7             |Провайдер временно недоступен                                 |
|8             |Платеж обрабатывается провайдером                             |
|9             |Сервис не поддерживает отмену платежей                        |
|10            |Ошибка при загрузке платежей (только в запросе 4.2.4)         |
|11            |Платеж за границы допустимых сумм                             |
|12            |Ошибка связи с сервером провайдера или технологический перерыв|
|13            |Сессия с таким номером не существует                          |
|14            |Платеж отклонен провайдером                                   |
|15            |Платеж отклонен системой Амега                                |
|16            |Не верное расширение файла                                    |
|99            |Общая ошибка системы                                          |
|119           |Сервис не работает в указанной валюте                         |
|120           |Данные о пользователе не подтверждены                         |
|121           |Указана неверная валюта                                       |
|122	       |Невозможно разбить платёж по максимальной границе   		  |
|123	       |Поле дата имеет не валидный формат (YYYY-mm-dd H:M:S)         |
|133	       |Перевод средств на учётную запись не являющуюся Резидентом РФ запрещена|
##Приложение C: Требование к безопасности.

Для проверки целостности входных/выходных данных операции используется контрольная подпись. Для использования 
контрольной подписи отправитель должен обладать секретным ключом (RSA или DES), с помощью которого он генерирует 
контрольный код, получатель – открытым ключом, используя который он расшифровывает полученный контрольный код и 
осуществляет проверку целостности.
 
Контрольная подпись (ЭЦП) формируется в два этапа:
 
1. Вычисление свертки отправляемых данных
 
2. Получение контрольного кода шифрованием свертки
 
Вычисление свертки осуществляется с помощью алгоритма SHA1, в качестве строки, образующих контролируемые данные, берется 
передаваемое сообщение. Затем из строки контролируемых параметров с помощью алгоритма SHA1 отправителем вычисляется 
свертка.

##Работа с RSA

Генерация  RSA  ключей с помощью пакета OpenSSL

##Пакет OpenSSL

OpenSSL — криптографический пакет с открытым исходным кодом для работы с SSL/TLS.

Позволяет создавать ключи RSA, DH, DSA и сертификаты X.509, подписывать их, формировать CSR и CRT. Также имеется 
возможность шифрования данных и тестирования SSL/TLS соединений.

##Получение пакета OpenSSL

Скачать OpenSSL в виде исходных кодов можно на сайте: http://www.openssl.org/ А также в виде скомпилированной библиотеки 
под систему Windows по следующей ссылке:http://www.slproweb.com/products/Win32OpenSSL.html

Дальнейшее описание предполагает, что вы скачали OpenSSL в виде библиотеки под Windows.

##Генерация приватного ключа

1. Для начала необходимо создать файл со случайными данными, следующей командой:
```
openssl rand -out random 1048576
```
2. Генерация приватного ключа в формате PEM (далее он будет переведен в DER):
```
openssl genrsa -out secret.key.pem -rand random 1024
```
3. С помощью созданного приватного ключа генерируем публичный в формате DER:
```
openssl rsa -in secret.key.pem -pubout -outform DER -out public.key
```
4. Переводим приватный ключ из формата PEM в формат DER:
```
openssl rsa -inform pem -in secret.key.pem -outform der -out secret.key
```
В итоге получим 4 файла:
```
random
public.key
secret.key
secret.key.pem
```
Для дальнейшей работы понадобятся  public.key и secret.key, а random и secret.key.pem можно удалить.

Все шаги можно свести воедино в bat файле (скопируйте следующие строки, создайте файл, например gen.bat, и вставте в 
файл) (в первой строке, возможно, понадобится исправить путь):
```
set PATH=C:\OpenSSL\bin
openssl rand -out random 1048576
openssl genrsa -out secret.key.pem -rand random 1024
openssl rsa -in secret.key.pem -pubout -outform DER -out public.key
openssl rsa -inform pem -in secret.key.pem -outform der -out secret.key
del random
del secret.key.pem
```

##Примеры использования RSA
 
Формирование подписи командами  OpenSSL

Windows:
```
type file_to_sign.txt | openssl dgst -md5 -binary -keyform der -sign secret.key | openssl base64 -A
```
Linux:
```
cat file_to_sign.txt | openssl dgst -md5 -binary -keyform der -sign secret.key | openssl base64 -A
```

##Формирование  подписи на PHP
```
$privateKey = “secret.key”;
function sign($data) {
	global $privateKey;
	$handle = popen("echo -n '$data' | openssl dgst -md5 -binary -keyform DER -sign $privateKey  | openssl base64 -A", "r");
	$read = fread($handle, 2096);
	pclose($handle);
	return $read;
}
```
